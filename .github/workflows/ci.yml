name: "CI â€” Affected or Full"

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    # Keep CI on main, and also run on Renovate branches so branch-style automerge waits for checks
    branches:
      - "main"
      - "renovate/**"

# cancel the previous run and run only on the most recent pushed commit
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

env:
  DATABASE_URL: "test" # Use test variable for now, needed for portfolio-manager postinstall scripts

jobs:
  affected:
    name: "Run affected build / lint / test"
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '22.20.0'
          cache: 'npm'

      - name: Determine base and head shas
        id: vars
        run: |
          if [ "$GITHUB_EVENT_NAME" = "pull_request" ]; then
            echo "BASE=${{ github.event.pull_request.base.sha }}" >> $GITHUB_ENV
            echo "HEAD=${{ github.event.pull_request.head.sha }}" >> $GITHUB_ENV
          else
            echo "BASE=${{ github.event.before }}" >> $GITHUB_ENV
            echo "HEAD=${{ github.sha }}" >> $GITHUB_ENV
          fi

      - name: Detect package/lockfile changes
        id: detect
        run: |
          changed_files=$(git diff --name-only $BASE $HEAD || true)
          echo "Changed files:\n$changed_files"
          if echo "$changed_files" | grep -E '(^|/)package(-lock)?\.json$|pnpm-lock.yaml|yarn.lock' >/dev/null; then
            echo "RUN_ALL=true" >> $GITHUB_ENV
          else
            echo "RUN_ALL=false" >> $GITHUB_ENV
          fi

      - name: Install dependencies
        run: npm ci

      - name: "Full Run: Build"
        if: env.RUN_ALL == 'true'
        run: npx nx run-many --target=build --all --parallel

      - name: "Affected: Build"
        if: env.RUN_ALL != 'true'
        run: npx nx affected --target=build --base=$BASE --head=$HEAD --parallel

      - name: "Full Run: Lint"
        if: env.RUN_ALL == 'true'
        run: npx nx run-many --target=lint --all --parallel

      - name: "Affected: Lint"
        if: env.RUN_ALL != 'true'
        run: npx nx affected --target=lint --base=$BASE --head=$HEAD --parallel

      - name: "Full Run: Test"
        if: env.RUN_ALL == 'true'
        run: npx nx run-many --target=test --all --parallel --ci

      - name: "Affected: Test"
        if: env.RUN_ALL != 'true'
        run: npx nx affected --target=test --base=$BASE --head=$HEAD --parallel --ci
