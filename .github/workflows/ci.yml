name: "CI â€” Affected or Full"

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    # Keep CI on main, and also run on Renovate branches so branch-style automerge waits for checks
    branches:
      - "main"
      - "renovate/**"

# cancel the previous run and run only on the most recent pushed commit
concurrency:
  # Use the commit SHA (PR head sha or the workflow's sha) so runs for the same commit dedupe
  group: ${{ github.workflow }}-${{ github.event.pull_request.head.sha || github.sha || github.ref}}
  cancel-in-progress: true

env:
  DATABASE_URL: "test" # Use test variable for now, needed for portfolio-manager postinstall scripts

jobs:
  affected:
    name: "Run affected build / lint / test"
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '24.11.1'
          cache: 'npm'

      - name: Determine base and head shas
        id: vars
        run: |
          if [ "$GITHUB_EVENT_NAME" = "pull_request" ]; then
            # Prefer SHAs when available, otherwise fall back to remote branch ref (origin/<base_ref>)
            if [ "${{ github.event.pull_request.base.sha }}" != "0000000000000000000000000000000000000000" ]; then
              echo "BASE=${{ github.event.pull_request.base.sha }}" >> $GITHUB_ENV
            else
              echo "BASE=origin/${{ github.event.pull_request.base.ref }}" >> $GITHUB_ENV
              git fetch origin ${{ github.event.pull_request.base.ref }} --depth=1 || true
            fi
            # For HEAD, prefer the PR head sha; fallback to head ref if needed
            if [ "${{ github.event.pull_request.head.sha }}" != "0000000000000000000000000000000000000000" ]; then
              echo "HEAD=${{ github.event.pull_request.head.sha }}" >> $GITHUB_ENV
            else
              echo "HEAD=origin/${{ github.event.pull_request.head.ref }}" >> $GITHUB_ENV
              git fetch origin ${{ github.event.pull_request.head.ref }} --depth=1 || true
            fi
          else
            # Push events: if before is available and not the zero SHA, use it. Otherwise fallback to origin/main
            if [ "${{ github.event.before }}" != "0000000000000000000000000000000000000000" ]; then
              echo "BASE=${{ github.event.before }}" >> $GITHUB_ENV
            else
              # Fallback to the repository's default branch instead of hardcoding `main`
              echo "BASE=origin/${{ github.event.repository.default_branch }}" >> $GITHUB_ENV
              git fetch origin ${{ github.event.repository.default_branch }} --depth=1 || true
            fi
            echo "HEAD=${{ github.sha }}" >> $GITHUB_ENV
          fi

      - name: Detect package/lockfile changes
        id: detect
        run: |
          changed_files=$(git diff --name-only $BASE $HEAD || true)
          echo "Changed files:\n$changed_files"
          if echo "$changed_files" | grep -E '(^|/)package(-lock)?\.json$|.nvmrc' >/dev/null; then
            echo "RUN_ALL=true" >> $GITHUB_ENV
          else
            echo "RUN_ALL=false" >> $GITHUB_ENV
          fi

      - name: Install dependencies
        run: npm ci

      - name: "Full Run: Build"
        if: env.RUN_ALL == 'true'
        run: npx nx run-many --target=build --all --parallel

      - name: "Affected: Build"
        if: env.RUN_ALL != 'true'
        run: npx nx affected --target=build --base=$BASE --head=$HEAD --parallel

      - name: "Full Run: Lint"
        if: env.RUN_ALL == 'true'
        run: npx nx run-many --target=lint --all --parallel

      - name: "Affected: Lint"
        if: env.RUN_ALL != 'true'
        run: npx nx affected --target=lint --base=$BASE --head=$HEAD --parallel

      - name: "Full Run: Test"
        if: env.RUN_ALL == 'true'
        run: npx nx run-many --target=test --all --parallel --ci

      - name: "Affected: Test"
        if: env.RUN_ALL != 'true'
        run: npx nx affected --target=test --base=$BASE --head=$HEAD --parallel --ci
