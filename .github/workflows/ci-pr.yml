name: "CI â€” PR"

on:
  pull_request:
    types: [opened, synchronize, reopened]

concurrency:
  # Cancel older runs for the same PR; push and PR runs are separated by different workflows
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

env:
  DATABASE_URL: "test" # Needed for portfolio-manager postinstall scripts

jobs:
  prepare:
    name: "Prepare"
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
    outputs:
      base: ${{ steps.vars.outputs.base }}
      head: ${{ steps.vars.outputs.head }}
      run_all: ${{ steps.detect.outputs.run_all }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version-file: .nvmrc
          cache: npm

      - name: Cache Nx
        uses: actions/cache@v4
        with:
          path: ~/.cache/nx
          key: nx-${{ runner.os }}-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            nx-${{ runner.os }}-

      - name: Determine base and head shas
        id: vars
        run: |
          # Prefer SHAs when available, otherwise fall back to remote branch ref (origin/<base_ref>)
          if [ "${{ github.event.pull_request.base.sha }}" != "0000000000000000000000000000000000000000" ]; then
            echo "base=${{ github.event.pull_request.base.sha }}" >> $GITHUB_OUTPUT
          else
            echo "base=origin/${{ github.event.pull_request.base.ref }}" >> $GITHUB_OUTPUT
            git fetch origin ${{ github.event.pull_request.base.ref }} --depth=1 || true
          fi
          # For HEAD, prefer the PR head sha; fallback to head ref if needed
          if [ "${{ github.event.pull_request.head.sha }}" != "0000000000000000000000000000000000000000" ]; then
            echo "head=${{ github.event.pull_request.head.sha }}" >> $GITHUB_OUTPUT
          else
            echo "head=origin/${{ github.event.pull_request.head.ref }}" >> $GITHUB_OUTPUT
            git fetch origin ${{ github.event.pull_request.head.ref }} --depth=1 || true
          fi

      - name: Detect package/lockfile changes
        id: detect
        env:
          BASE: ${{ steps.vars.outputs.base }}
          HEAD: ${{ steps.vars.outputs.head }}
        run: |
          changed_files=$(git diff --name-only "$BASE" "$HEAD" || true)
          echo "Changed files:\n$changed_files"
          if echo "$changed_files" | grep -E '(^|/)package(-lock)?\.json$|.nvmrc' >/dev/null; then
            echo "run_all=true" >> $GITHUB_OUTPUT
          else
            echo "run_all=false" >> $GITHUB_OUTPUT
          fi

  lint:
    name: "Lint"
    runs-on: ubuntu-latest
    permissions:
      contents: read
    needs: prepare
    if: needs.prepare.outputs.run_all != '' # ensure prepare completed (even if false)
    env:
      BASE: ${{ needs.prepare.outputs.base }}
      HEAD: ${{ needs.prepare.outputs.head }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version-file: .nvmrc
          cache: npm

      - name: Cache Nx
        uses: actions/cache@v4
        with:
          path: ~/.cache/nx
          key: nx-${{ runner.os }}-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            nx-${{ runner.os }}-

      - name: Install dependencies
        run: npm ci

      - name: "Full Run: Lint"
        if: needs.prepare.outputs.run_all == 'true'
        run: npx nx run-many --target=lint --all --parallel

      - name: "Affected: Lint"
        if: needs.prepare.outputs.run_all != 'true'
        run: npx nx affected --target=lint --base=$BASE --head=$HEAD --parallel

      - name: Upload artifacts on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: lint-logs
          path: |
            .nx/cache/terminalOutputs
            **/junit*.xml
            **/test-results/**/*.xml
          if-no-files-found: ignore

  test:
    name: "Test"
    runs-on: ubuntu-latest
    permissions:
      contents: read
    needs: prepare
    if: needs.prepare.outputs.run_all != ''
    env:
      BASE: ${{ needs.prepare.outputs.base }}
      HEAD: ${{ needs.prepare.outputs.head }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version-file: .nvmrc
          cache: npm

      - name: Cache Nx
        uses: actions/cache@v4
        with:
          path: ~/.cache/nx
          key: nx-${{ runner.os }}-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            nx-${{ runner.os }}-

      - name: Install dependencies
        run: npm ci

      - name: "Full Run: Test"
        if: needs.prepare.outputs.run_all == 'true'
        run: npx nx run-many --target=test --all --parallel --ci

      - name: "Affected: Test"
        if: needs.prepare.outputs.run_all != 'true'
        run: npx nx affected --target=test --base=$BASE --head=$HEAD --parallel --ci

      - name: Upload artifacts on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: test-logs
          path: |
            .nx/cache/terminalOutputs
            **/junit*.xml
            **/test-results/**/*.xml
          if-no-files-found: ignore

  build:
    name: "Build"
    runs-on: ubuntu-latest
    permissions:
      contents: read
    needs: prepare
    if: needs.prepare.outputs.run_all != ''
    env:
      BASE: ${{ needs.prepare.outputs.base }}
      HEAD: ${{ needs.prepare.outputs.head }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version-file: .nvmrc
          cache: npm

      - name: Cache Nx
        uses: actions/cache@v4
        with:
          path: ~/.cache/nx
          key: nx-${{ runner.os }}-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            nx-${{ runner.os }}-

      - name: Install dependencies
        run: npm ci

      - name: "Full Run: Build"
        if: needs.prepare.outputs.run_all == 'true'
        run: npx nx run-many --target=build --all --parallel

      - name: "Affected: Build"
        if: needs.prepare.outputs.run_all != 'true'
        run: npx nx affected --target=build --base=$BASE --head=$HEAD --parallel

      - name: Upload artifacts on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs
          path: |
            .nx/cache/terminalOutputs
            **/junit*.xml
            **/test-results/**/*.xml
          if-no-files-found: ignore
